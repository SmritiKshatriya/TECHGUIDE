<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechGuide ‚Äî Career Quiz</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>

<nav class="navbar">
    <a href="/" class="navbar-logo">Tech Guide üöÄ</a>
    <div class="navbar-links">
        <a href="/">Home</a>
        <a href="/quiz/">Quiz</a>
        <a href="/roadmap/">Roadmaps</a>
        <a href="/quiz/" class="btn-primary">Start Quiz</a>
    </div>
</nav>

<div class="quiz-container">
    <div id="loading">Loading quiz...</div>

    <div id="quiz-area" style="display:none;">
        <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progress-bar"></div>
        </div>
        <p class="progress-text" id="progress-text">Question 1 of 4</p>
        <div class="category-badge" id="category-badge">INTEREST</div>
        <div class="question-text" id="question-text"></div>
        <div class="choices-list" id="choices-list"></div>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next ‚Üí</button>
        <div class="error-box" id="error-box">Something went wrong, please try again</div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        Analyzing your answers... üîç
    </div>
</div>

<script>
    let questions = [];
    let currentIndex = 0;
    let answers = {};
    let selectedChoiceId = null;

    // Load questions from API on page load
    async function loadQuestions() {
        try {
            const res = await fetch('/api/quiz/questions/');
            const data = await res.json();
            questions = data;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            showQuestion(0);
        } catch (err) {
            document.getElementById('loading').textContent = 'Failed to load quiz. Please refresh.';
        }
    }

    // Show a single question by index
    function showQuestion(index) {
        const q = questions[index];
        selectedChoiceId = null;

        // Update progress
        const pct = ((index) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = pct + '%';
        document.getElementById('progress-text').textContent = 
            'Question ' + (index + 1) + ' of ' + questions.length;
        document.getElementById('category-badge').textContent = q.category;
        document.getElementById('question-text').textContent = q.question_text;

        // Render choices
        const choicesList = document.getElementById('choices-list');
        choicesList.innerHTML = '';
        q.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'choice-card';
            btn.textContent = choice.choice_text;
            btn.dataset.choiceId = choice.id;
            btn.onclick = () => selectChoice(choice.id, btn);
            choicesList.appendChild(btn);
        });

        // Hide next button and error
        document.getElementById('next-btn').classList.remove('visible');
        document.getElementById('error-box').classList.remove('visible');

        // Update next/submit button label
        const nextBtn = document.getElementById('next-btn');
        nextBtn.textContent = index === questions.length - 1 ? 'See My Results ‚Üí' : 'Next ‚Üí';
    }

    // Handle choice selection
    function selectChoice(choiceId, clickedBtn) {
        // Remove selected from all cards
        document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
        // Add selected to clicked
        clickedBtn.classList.add('selected');
        selectedChoiceId = choiceId;
        // Show next button
        document.getElementById('next-btn').classList.add('visible');
    }

    // Go to next question or submit
    function nextQuestion() {
        if (!selectedChoiceId) return;

        // Save answer: question_id -> choice_id (both as strings)
        const currentQuestion = questions[currentIndex];
        answers[String(currentQuestion.id)] = String(selectedChoiceId);

        if (currentIndex < questions.length - 1) {
            currentIndex++;
            showQuestion(currentIndex);
        } else {
            submitQuiz();
        }
    }

    // Submit answers to backend
    // Get CSRF token from browser cookies
    function getCookie(name) {
        let value = null;
        if (document.cookie) {
            document.cookie.split(';').forEach(c => {
                c = c.trim();
                if (c.startsWith(name + '=')) {
                    value = decodeURIComponent(c.substring(name.length + 1));
                }
            });
        }
        return value;
    }

    // Submit answers to backend
    async function submitQuiz() {
        document.getElementById('loading-overlay').classList.add('visible');
        console.log('Submitting answers:', answers);

        try {
            const res = await fetch('/api/quiz/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ answers: answers })
            });

            const data = await res.json();

            if (res.ok) {
                localStorage.setItem('quizResults', JSON.stringify(data));
                window.location.href = '/results/';
            } else {
                throw new Error('Server error');
            }
        } catch (err) {
            document.getElementById('loading-overlay').classList.remove('visible');
            document.getElementById('error-box').classList.add('visible');
        }
    }

    // Start loading questions immediately
    loadQuestions();
</script>

</body>
</html>
